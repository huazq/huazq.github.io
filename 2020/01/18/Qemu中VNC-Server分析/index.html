<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Qemu中VNC Server分析 | huazq's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Qemu中VNC Server分析</h1><a id="logo" href="/.">huazq's blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Qemu中VNC Server分析</h1><div class="post-meta">Jan 18, 2020<span> | </span><span class="category"><a href="/categories/虚拟化/">虚拟化</a></span></div><a class="disqus-comment-count" href="/2020/01/18/Qemu中VNC-Server分析/#vcomment"><span class="valine-comment-count" data-xid="/2020/01/18/Qemu中VNC-Server分析/"></span><span> 条评论</span></a><div class="post-content"><h2 id="VNC介绍"><a href="#VNC介绍" class="headerlink" title="VNC介绍"></a>VNC介绍</h2><p>vnc是一个桌面传输协议，使用的是RFB协议格式，RFB协议是一个基于TCP的应用层传输协议。基于vnc协议实现的程序有很多，最出名的两个就是大家所熟悉的TightVNC和RealVNC。同样，Qemu模拟器中也实现了vnc(qemu中的vnc为Server端)，qemu中的vnc是为了用于展示虚拟机的界面，方便用户和虚拟机交互，今天就来分析下Qemu中的vnc实现。</p>
<h2 id="Qemu中VNC参数"><a href="#Qemu中VNC参数" class="headerlink" title="Qemu中VNC参数"></a>Qemu中VNC参数</h2><p>Qemu是在vl.c的main函数中通过QEMU_OPTION_vnc选项对vnc命令行参数进行解析，vnc的参数格式定义在vnc.c文件中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> QemuOptsList qemu_vnc_opts = &#123;</span><br><span class="line">    .name = <span class="string">"vnc"</span>,</span><br><span class="line">    .head = QTAILQ_HEAD_INITIALIZER(qemu_vnc_opts.head),</span><br><span class="line">    .implied_opt_name = <span class="string">"vnc"</span>,</span><br><span class="line">    .desc = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            .name = <span class="string">"vnc"</span>,</span><br><span class="line">            .type = QEMU_OPT_STRING,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"websocket"</span>,</span><br><span class="line">            .type = QEMU_OPT_STRING,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"tls-creds"</span>,</span><br><span class="line">            .type = QEMU_OPT_STRING,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"share"</span>,</span><br><span class="line">            .type = QEMU_OPT_STRING,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"display"</span>,</span><br><span class="line">            .type = QEMU_OPT_STRING,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"head"</span>,</span><br><span class="line">            .type = QEMU_OPT_NUMBER,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"connections"</span>,</span><br><span class="line">            .type = QEMU_OPT_NUMBER,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"to"</span>,</span><br><span class="line">            .type = QEMU_OPT_NUMBER,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"ipv4"</span>,</span><br><span class="line">            .type = QEMU_OPT_BOOL,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"ipv6"</span>,</span><br><span class="line">            .type = QEMU_OPT_BOOL,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"password"</span>,</span><br><span class="line">            .type = QEMU_OPT_BOOL,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"reverse"</span>,</span><br><span class="line">            .type = QEMU_OPT_BOOL,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"lock-key-sync"</span>,</span><br><span class="line">            .type = QEMU_OPT_BOOL,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"key-delay-ms"</span>,</span><br><span class="line">            .type = QEMU_OPT_NUMBER,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"sasl"</span>,</span><br><span class="line">            .type = QEMU_OPT_BOOL,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"acl"</span>,</span><br><span class="line">            .type = QEMU_OPT_BOOL,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"tls-authz"</span>,</span><br><span class="line">            .type = QEMU_OPT_STRING,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"sasl-authz"</span>,</span><br><span class="line">            .type = QEMU_OPT_STRING,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"lossy"</span>,</span><br><span class="line">            .type = QEMU_OPT_BOOL,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            .name = <span class="string">"non-adaptive"</span>,</span><br><span class="line">            .type = QEMU_OPT_BOOL,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; <span class="comment">/* end of list */</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="上述参数含义"><a href="#上述参数含义" class="headerlink" title="上述参数含义"></a>上述参数含义</h3><table>
<thead>
<tr>
<th>名称</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>vnc</td>
<td>vnc地址</td>
</tr>
<tr>
<td>websocket</td>
<td>是否使用websocket协议</td>
</tr>
<tr>
<td>tls-creds</td>
<td>tls证书</td>
</tr>
<tr>
<td>share</td>
<td>vnc协议的共享策略(忽略、排他、强制共享三种策略)</td>
</tr>
<tr>
<td>display</td>
<td>展示哪个串口设备</td>
</tr>
<tr>
<td>head</td>
<td>和display一起使用，用于判断串口设备</td>
</tr>
<tr>
<td>connections</td>
<td>vnc连接数限制，默认32</td>
</tr>
<tr>
<td>to</td>
<td>是否使用websocket协议</td>
</tr>
<tr>
<td>ipv4</td>
<td>vnc地址使用ipv4格式</td>
</tr>
<tr>
<td>ipv6</td>
<td>vnc地址使用ipv6格式</td>
</tr>
<tr>
<td>password</td>
<td>vnc密码</td>
</tr>
<tr>
<td>reverse</td>
<td></td>
</tr>
<tr>
<td>lock-key-sync</td>
<td>numlock以及capslock键状态同步</td>
</tr>
<tr>
<td>key-delay-ms</td>
<td>键盘输入延迟时间(单位:毫秒)</td>
</tr>
<tr>
<td>sasl</td>
<td>是否开启sasl认证</td>
</tr>
<tr>
<td>acl</td>
<td>不再使用</td>
</tr>
<tr>
<td>tls-authz</td>
<td>vnc使用tls认证</td>
</tr>
<tr>
<td>sasl-authz</td>
<td>vnc使用sasl认证</td>
</tr>
<tr>
<td>lossy</td>
<td>如果启用lossy，则禁用adaptive updates,即低质量画面传输</td>
</tr>
<tr>
<td>non-adaptive</td>
<td>是否使用高质量画面传输(禁用压缩)</td>
</tr>
<tr>
<td>## VNC主要数据结构</td>
<td></td>
</tr>
<tr>
<td><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncDisplay</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    QTAILQ_HEAD(, VncState) clients;</span><br><span class="line">    <span class="keyword">int</span> num_connecting;</span><br><span class="line">    <span class="keyword">int</span> num_shared;</span><br><span class="line">    <span class="keyword">int</span> num_exclusive;</span><br><span class="line">    <span class="keyword">int</span> connections_limit;</span><br><span class="line">    VncSharePolicy share_policy;</span><br><span class="line">    QIONetListener *listener;</span><br><span class="line">    QIONetListener *wslistener;</span><br><span class="line">    DisplaySurface *ds;</span><br><span class="line">    DisplayChangeListener dcl;</span><br><span class="line">    <span class="keyword">kbd_layout_t</span> *kbd_layout;</span><br><span class="line">    <span class="keyword">int</span> lock_key_sync;</span><br><span class="line">    QEMUPutLEDEntry *led;</span><br><span class="line">    <span class="keyword">int</span> ledstate;</span><br><span class="line">    QKbdState *kbd;</span><br><span class="line">    QemuMutex mutex;</span><br><span class="line"></span><br><span class="line">    QEMUCursor *cursor;</span><br><span class="line">    <span class="keyword">int</span> cursor_msize;</span><br><span class="line">    <span class="keyword">uint8_t</span> *cursor_mask;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">VncSurface</span> <span class="title">guest</span>;</span>   <span class="comment">/* guest visible surface (aka ds-&gt;surface) */</span></span><br><span class="line">    <span class="keyword">pixman_image_t</span> *server;    <span class="comment">/* vnc server surface */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *id;</span><br><span class="line">    QTAILQ_ENTRY(VncDisplay) next;</span><br><span class="line">    <span class="keyword">bool</span> is_unix;</span><br><span class="line">    <span class="keyword">char</span> *password;</span><br><span class="line">    <span class="keyword">time_t</span> expires;</span><br><span class="line">    <span class="keyword">int</span> auth;</span><br><span class="line">    <span class="keyword">int</span> subauth; <span class="comment">/* Used by VeNCrypt */</span></span><br><span class="line">    <span class="keyword">int</span> ws_auth; <span class="comment">/* Used by websockets */</span></span><br><span class="line">    <span class="keyword">int</span> ws_subauth; <span class="comment">/* Used by websockets */</span></span><br><span class="line">    <span class="keyword">bool</span> lossy;</span><br><span class="line">    <span class="keyword">bool</span> non_adaptive;</span><br><span class="line">    QCryptoTLSCreds *tlscreds;</span><br><span class="line">    QAuthZ *tlsauthz;</span><br><span class="line">    <span class="keyword">char</span> *tlsauthzid;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VNC_SASL</span></span><br><span class="line">    VncDisplaySASL sasl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></td>
<td></td>
</tr>
</tbody></table>
<p><strong>VncDisplay</strong>:代表一个VNC Server的结构体，在qemu解析参数并初始化vnc的时候会调用到vnc_display_init，在这里会分配一个VncDisplay实例，并加入到全局链表vnc_displays(如果配置了多个vnc,则全局链表中有多个VncDisplay实例，即代表qemu有多个VNC Server)，可以看到VncDisplay结构体中的大部分参数和我们之前讲的qemu命令行中vnc参数是一致的，这里不再对VncDisplay结构体的参数详细阐述。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> magic;   <span class="comment">/* 0x05b3f069b3d204bb */</span></span><br><span class="line">    QIOChannelSocket *sioc; <span class="comment">/* The underlying socket，socket wrapper */</span></span><br><span class="line">    QIOChannel *ioc; <span class="comment">/* The channel currently used for I/O */</span></span><br><span class="line">    guint ioc_tag;</span><br><span class="line">    gboolean disconnecting;</span><br><span class="line"></span><br><span class="line">    DECLARE_BITMAP(dirty[VNC_MAX_HEIGHT], VNC_DIRTY_BITS);</span><br><span class="line">    <span class="keyword">uint8_t</span> **lossy_rect; <span class="comment">/* Not an Array to avoid costly memcpy in</span></span><br><span class="line"><span class="comment">                           * vnc-jobs-async.c */</span></span><br><span class="line"></span><br><span class="line">    VncDisplay *vd; <span class="comment">/*vnc server connect to*/</span></span><br><span class="line">    VncStateUpdate update; <span class="comment">/* Most recent pending request from client */</span></span><br><span class="line">    VncStateUpdate job_update; <span class="comment">/* Currently processed by job thread */</span></span><br><span class="line">    <span class="keyword">int</span> has_dirty;</span><br><span class="line">    <span class="keyword">uint32_t</span> features;</span><br><span class="line">    <span class="keyword">int</span> absolute;</span><br><span class="line">    <span class="keyword">int</span> last_x;</span><br><span class="line">    <span class="keyword">int</span> last_y;</span><br><span class="line">    <span class="keyword">uint32_t</span> last_bmask;</span><br><span class="line">    <span class="keyword">size_t</span> client_width; <span class="comment">/* limited to u16 by RFB proto */</span></span><br><span class="line">    <span class="keyword">size_t</span> client_height; <span class="comment">/* limited to u16 by RFB proto */</span></span><br><span class="line">    VncShareMode share_mode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> vnc_encoding;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> major;</span><br><span class="line">    <span class="keyword">int</span> minor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> auth;</span><br><span class="line">    <span class="keyword">int</span> subauth; <span class="comment">/* Used by VeNCrypt */</span></span><br><span class="line">    <span class="keyword">char</span> challenge[VNC_AUTH_CHALLENGE_SIZE];</span><br><span class="line">    QCryptoTLSSession *tls; <span class="comment">/* Borrowed pointer from channel, don't free */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VNC_SASL</span></span><br><span class="line">    VncStateSASL sasl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">bool</span> encode_ws;</span><br><span class="line">    <span class="keyword">bool</span> websocket;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VNC</span></span><br><span class="line">    VncClientInfo *info;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Job thread bottom half has put data for a forced update</span></span><br><span class="line"><span class="comment">     * into the output buffer. This offset points to the end of</span></span><br><span class="line"><span class="comment">     * the update data in the output buffer. This lets us determine</span></span><br><span class="line"><span class="comment">     * when a force update is fully sent to the client, allowing</span></span><br><span class="line"><span class="comment">     * us to process further forced updates. */</span></span><br><span class="line">    <span class="keyword">size_t</span> force_update_offset;</span><br><span class="line">    <span class="comment">/* We allow multiple incremental updates or audio capture</span></span><br><span class="line"><span class="comment">     * samples to be queued in output buffer, provided the</span></span><br><span class="line"><span class="comment">     * buffer size doesn't exceed this threshold. The value</span></span><br><span class="line"><span class="comment">     * is calculating dynamically based on framebuffer size</span></span><br><span class="line"><span class="comment">     * and audio sample settings in vnc_update_throttle_offset() */</span></span><br><span class="line">    <span class="keyword">size_t</span> throttle_output_offset;</span><br><span class="line">    Buffer output;</span><br><span class="line">    Buffer input;</span><br><span class="line">    <span class="comment">/* current output mode information */</span></span><br><span class="line">    VncWritePixels *write_pixels;</span><br><span class="line">    PixelFormat client_pf;</span><br><span class="line">    <span class="keyword">pixman_format_code_t</span> client_format;</span><br><span class="line">    <span class="keyword">bool</span> client_be;</span><br><span class="line"></span><br><span class="line">    CaptureVoiceOut *audio_cap;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">audsettings</span> <span class="title">as</span>;</span></span><br><span class="line"></span><br><span class="line">    VncReadEvent *read_handler;</span><br><span class="line">    <span class="keyword">size_t</span> read_handler_expect;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> <span class="built_in">abort</span>;</span><br><span class="line">    QemuMutex output_mutex;</span><br><span class="line">    QEMUBH *bh;</span><br><span class="line">    Buffer jobs_buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Encoding specific, if you add something here, don't forget to</span></span><br><span class="line"><span class="comment">     *  update vnc_async_encoding_start()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    VncTight tight;</span><br><span class="line">    VncZlib zlib;</span><br><span class="line">    VncHextile hextile;</span><br><span class="line">    VncZrle zrle;</span><br><span class="line">    VncZywrle zywrle;</span><br><span class="line"></span><br><span class="line">    Notifier mouse_mode_notifier;</span><br><span class="line"></span><br><span class="line">    QTAILQ_ENTRY(VncState) next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>VncState</strong>:表示VNC Client的状态信息，在VncDisplay有个client链表(QTAILQ_HEAD(, VncState) clients;)，即每个VNC Server(VncDisplay)可能会有多个client连接(默认最高32个client),每个client都会有一些状态信息(包括client channel, dirty bitmap，宽高，共享模式，auth方式，连接方式(ws or tcp ),音频采集以及数据压缩方式等等)，VncState就是用来报存这些状态信息的.</p>
<p><strong>VncState中包含的几种VNC编码方式</strong>：<br></p>
<ul>
<li><strong><em>VncTight</em></strong>：即Tight Encoding，包含四种压缩类型:fill, jpeg, png, basic。Tight Encoding是一种自适应的轻量级编码方式，会根据传输数据动态决定使用哪种压缩方式。<br></li>
<li><strong><em>VncZlib</em></strong>：zlib压缩，即vnc数据传输使用标准的zlib压缩。<br></li>
<li><strong><em>VncHextile</em></strong>：Hextile编码是RRE编码(RRE是将象素颜色相同的某一个矩形区域作为一个整体传输)的变种，把屏幕分成16x16象素的小块，每块用Raw或RRE方式转送，详细可以参考<a href="https://tools.ietf.org/html/rfc6143" target="_blank" rel="noopener">RFB协议</a>。<br></li>
<li><strong><em>VncZrle</em></strong>：zrle编码就是zlib的游标编码(run-length encoding)，详细可以参考<a href="https://tools.ietf.org/html/rfc6143" target="_blank" rel="noopener">RFB协议</a><br></li>
<li><strong><em>VncZywrle</em></strong>：zywrle表示ZLib YUV Wavelet Run Length Encoding，zywrle编码是为了提高VNC codec for Motion picture，即可以以更高质量的压缩数据，具体可参考<a href="https://forum.ultravnc.net/viewtopic.php?t=9167" target="_blank" rel="noopener">zywrle说明</a><br></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncRect</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">int</span> y;</span><br><span class="line">    <span class="keyword">int</span> w;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncRectEntry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">VncRect</span> <span class="title">rect</span>;</span></span><br><span class="line">    QLIST_ENTRY(VncRectEntry) next;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncJob</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    VncState *vs;</span><br><span class="line"></span><br><span class="line">    QLIST_HEAD(, VncRectEntry) rectangles;</span><br><span class="line">    QTAILQ_ENTRY(VncJob) next;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncJobQueue</span> &#123;</span></span><br><span class="line">    QemuCond cond;</span><br><span class="line">    QemuMutex mutex;</span><br><span class="line">    QemuThread thread;</span><br><span class="line">    <span class="keyword">bool</span> <span class="built_in">exit</span>;</span><br><span class="line">    QTAILQ_HEAD(, VncJob) jobs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>VncRect</strong>:表示VNC 变化的区域信息，包含了变化区域坐上面坐标(x,y)，以及变化区域的宽w,高h<br><br><strong>VncRectEntry</strong>:将所有VNC 变化区域信息组成链表放在VncRectEntry结构中<br><br><strong>VncJob</strong>:表示一个更新的job，每个job包含当时所有的变化区域信息<br><br><strong>VncJobQueue</strong>:表示job队列，以及处理job的线程信息<br></p>
<h2 id="VNC初始化流程分析"><a href="#VNC初始化流程分析" class="headerlink" title="VNC初始化流程分析"></a>VNC初始化流程分析</h2><p>在vl.c中的main函数会解析vnc参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> QEMU_OPTION_vnc:</span><br><span class="line">   vnc_parse(optarg, &amp;error_fatal);</span><br><span class="line">   <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>之后在解析完参数后会调用vnc_init_func初始化vnc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* init remote displays */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VNC</span></span><br><span class="line">    qemu_opts_foreach(qemu_find_opts(<span class="string">"vnc"</span>), </span><br><span class="line">                  vnc_init_func, <span class="literal">NULL</span>,  &amp;error_fatal);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>vnc的实现主要在ui/vnc.c文件中(vnc的各种数据压缩方式的实现在其他文件)。 初始化入口是vnc_init_func函数，vnc_init_func函数中会调用vnc_display_init初始化VncDisplay，之后调用vnc_display_open监听客户端连接，vnc_init_func实现如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vnc_init_func</span><span class="params">(<span class="keyword">void</span> *opaque, QemuOpts *opts, Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Error *local_err = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> *id = (<span class="keyword">char</span> *)qemu_opts_id(opts);</span><br><span class="line"></span><br><span class="line">    assert(id);</span><br><span class="line">    vnc_display_init(id, &amp;local_err);</span><br><span class="line">    <span class="keyword">if</span> (local_err) &#123;</span><br><span class="line">        error_propagate(errp, local_err);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vnc_display_open(id, &amp;local_err);</span><br><span class="line">    <span class="keyword">if</span> (local_err != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        error_propagate(errp, local_err);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数vnc_display_init主要是初始化对应的VncDisplay以及启动worker线程处理vnc数据更新队列,以及注册对应的dcl_ops(监听显示设备变化的操作集):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vnc_display_init</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *id, Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VncDisplay *vd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vnc_display_find(id) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vd = g_malloc0(<span class="keyword">sizeof</span>(*vd));</span><br><span class="line"></span><br><span class="line">    vd-&gt;id = strdup(id);</span><br><span class="line">    QTAILQ_INSERT_TAIL(&amp;vnc_displays, vd, next);</span><br><span class="line"></span><br><span class="line">    QTAILQ_INIT(&amp;vd-&gt;clients);</span><br><span class="line">    vd-&gt;expires = TIME_MAX;</span><br><span class="line">    <span class="comment">/*默认是英文键盘*/</span></span><br><span class="line">    <span class="keyword">if</span> (keyboard_layout) &#123;</span><br><span class="line">        trace_vnc_key_map_init(keyboard_layout);</span><br><span class="line">        vd-&gt;kbd_layout = init_keyboard_layout(name2keysym,</span><br><span class="line">                                              keyboard_layout, errp);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vd-&gt;kbd_layout = init_keyboard_layout(name2keysym, <span class="string">"en-us"</span>, errp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!vd-&gt;kbd_layout) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vd-&gt;share_policy = VNC_SHARE_POLICY_ALLOW_EXCLUSIVE;<span class="comment">/*默认独享*/</span></span><br><span class="line">    vd-&gt;connections_limit = <span class="number">32</span>; <span class="comment">/*默认连接数为32*/</span></span><br><span class="line"></span><br><span class="line">    qemu_mutex_init(&amp;vd-&gt;mutex);</span><br><span class="line">    vnc_start_worker_thread();</span><br><span class="line"></span><br><span class="line">    vd-&gt;dcl.ops = &amp;dcl_ops;</span><br><span class="line">    register_displaychangelistener(&amp;vd-&gt;dcl);</span><br><span class="line">    vd-&gt;kbd = qkbd_state_init(vd-&gt;dcl.con);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DisplayChangeListenerOps表示当显示设备发生改变时所触发的操作，dcl_ops定义了vnc对显示设备变化时的相关操作:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> DisplayChangeListenerOps dcl_ops = &#123;</span><br><span class="line">    .dpy_name             = <span class="string">"vnc"</span>,</span><br><span class="line">    .dpy_refresh          = vnc_refresh,</span><br><span class="line">    .dpy_gfx_update       = vnc_dpy_update,</span><br><span class="line">    .dpy_gfx_switch       = vnc_dpy_switch,</span><br><span class="line">    .dpy_gfx_check_format = qemu_pixman_check_format,</span><br><span class="line">    .dpy_mouse_set        = vnc_mouse_set,</span><br><span class="line">    .dpy_cursor_define    = vnc_dpy_cursor_define,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>vnc_display_open中主要对qemu命令行传入的参数校验，之后会根据入参设置vnc监听地址、vnc密码、连接方式，共享方式、认证模式、连接数、压缩方式等，最后开始监听socket等待客户端连接：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vnc_display_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *id, Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VncDisplay *vd = vnc_display_find(id);</span><br><span class="line">    QemuOpts *opts = qemu_opts_find(&amp;qemu_vnc_opts, id);</span><br><span class="line">    SocketAddress **saddr = <span class="literal">NULL</span>, **wsaddr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">size_t</span> nsaddr, nwsaddr;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *share, *device_id;</span><br><span class="line">    QemuConsole *con;</span><br><span class="line">    <span class="keyword">bool</span> password = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> reverse = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *credid;</span><br><span class="line">    <span class="keyword">bool</span> sasl = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">int</span> acl = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *tlsauthz;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *saslauthz;</span><br><span class="line">    <span class="keyword">int</span> lock_key_sync = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> key_delay_ms;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!vd) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">"VNC display not active"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vnc_display_close(vd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!opts) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reverse = qemu_opt_get_bool(opts, <span class="string">"reverse"</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (vnc_display_get_addresses(opts, reverse, &amp;saddr, &amp;nsaddr,</span><br><span class="line">                                  &amp;wsaddr, &amp;nwsaddr, errp) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*设置vnc密码*/</span></span><br><span class="line">    password = qemu_opt_get_bool(opts, <span class="string">"password"</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (password) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fips_get_state()) &#123;</span><br><span class="line">            error_setg(errp,</span><br><span class="line">                       <span class="string">"VNC password auth disabled due to FIPS mode, "</span></span><br><span class="line">                       <span class="string">"consider using the VeNCrypt or SASL authentication "</span></span><br><span class="line">                       <span class="string">"methods as an alternative"</span>);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!qcrypto_cipher_supports(</span><br><span class="line">                QCRYPTO_CIPHER_ALG_DES_RFB, QCRYPTO_CIPHER_MODE_ECB)) &#123;</span><br><span class="line">            error_setg(errp,</span><br><span class="line">                       <span class="string">"Cipher backend does not support DES RFB algorithm"</span>);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*numlock和capslock状态同步*/</span></span><br><span class="line">    lock_key_sync = qemu_opt_get_bool(opts, <span class="string">"lock-key-sync"</span>, <span class="literal">true</span>);</span><br><span class="line">    key_delay_ms = qemu_opt_get_number(opts, <span class="string">"key-delay-ms"</span>, <span class="number">10</span>);</span><br><span class="line">    sasl = qemu_opt_get_bool(opts, <span class="string">"sasl"</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_VNC_SASL</span></span><br><span class="line">    <span class="keyword">if</span> (sasl) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">"VNC SASL auth requires cyrus-sasl support"</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_VNC_SASL */</span></span></span><br><span class="line">    credid = qemu_opt_get(opts, <span class="string">"tls-creds"</span>);</span><br><span class="line">    <span class="keyword">if</span> (credid) &#123;</span><br><span class="line">        Object *creds;</span><br><span class="line">        creds = object_resolve_path_component(</span><br><span class="line">            object_get_objects_root(), credid);</span><br><span class="line">        <span class="keyword">if</span> (!creds) &#123;</span><br><span class="line">            error_setg(errp, <span class="string">"No TLS credentials with id '%s'"</span>,</span><br><span class="line">                       credid);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">        vd-&gt;tlscreds = (QCryptoTLSCreds *)</span><br><span class="line">            object_dynamic_cast(creds,</span><br><span class="line">                                TYPE_QCRYPTO_TLS_CREDS);</span><br><span class="line">        <span class="keyword">if</span> (!vd-&gt;tlscreds) &#123;</span><br><span class="line">            error_setg(errp, <span class="string">"Object with id '%s' is not TLS credentials"</span>,</span><br><span class="line">                       credid);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">        object_ref(OBJECT(vd-&gt;tlscreds));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (vd-&gt;tlscreds-&gt;endpoint != QCRYPTO_TLS_CREDS_ENDPOINT_SERVER) &#123;</span><br><span class="line">            error_setg(errp,</span><br><span class="line">                       <span class="string">"Expecting TLS credentials with a server endpoint"</span>);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (qemu_opt_get(opts, <span class="string">"acl"</span>)) &#123;</span><br><span class="line">        error_report(<span class="string">"The 'acl' option to -vnc is deprecated. "</span></span><br><span class="line">                     <span class="string">"Please use the 'tls-authz' and 'sasl-authz' "</span></span><br><span class="line">                     <span class="string">"options instead"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    acl = qemu_opt_get_bool(opts, <span class="string">"acl"</span>, <span class="literal">false</span>);</span><br><span class="line">    tlsauthz = qemu_opt_get(opts, <span class="string">"tls-authz"</span>);</span><br><span class="line">    <span class="keyword">if</span> (acl &amp;&amp; tlsauthz) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">"'acl' option is mutually exclusive with the "</span></span><br><span class="line">                   <span class="string">"'tls-authz' option"</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (tlsauthz &amp;&amp; !vd-&gt;tlscreds) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">"'tls-authz' provided but TLS is not enabled"</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    saslauthz = qemu_opt_get(opts, <span class="string">"sasl-authz"</span>);</span><br><span class="line">    <span class="keyword">if</span> (acl &amp;&amp; saslauthz) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">"'acl' option is mutually exclusive with the "</span></span><br><span class="line">                   <span class="string">"'sasl-authz' option"</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (saslauthz &amp;&amp; !sasl) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">"'sasl-authz' provided but SASL auth is not enabled"</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*设置vnc共享策略*/</span></span><br><span class="line">    share = qemu_opt_get(opts, <span class="string">"share"</span>);</span><br><span class="line">    <span class="keyword">if</span> (share) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(share, <span class="string">"ignore"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            vd-&gt;share_policy = VNC_SHARE_POLICY_IGNORE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(share, <span class="string">"allow-exclusive"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            vd-&gt;share_policy = VNC_SHARE_POLICY_ALLOW_EXCLUSIVE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(share, <span class="string">"force-shared"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            vd-&gt;share_policy = VNC_SHARE_POLICY_FORCE_SHARED;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            error_setg(errp, <span class="string">"unknown vnc share= option"</span>);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vd-&gt;share_policy = VNC_SHARE_POLICY_ALLOW_EXCLUSIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    vd-&gt;connections_limit = qemu_opt_get_number(opts, <span class="string">"connections"</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VNC_JPEG</span></span><br><span class="line">    vd-&gt;lossy = qemu_opt_get_bool(opts, <span class="string">"lossy"</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    vd-&gt;non_adaptive = qemu_opt_get_bool(opts, <span class="string">"non-adaptive"</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">/* adaptive updates are only used with tight encoding and</span></span><br><span class="line"><span class="comment">     * if lossy updates are enabled so we can disable all the</span></span><br><span class="line"><span class="comment">     * calculations otherwise */</span></span><br><span class="line">    <span class="keyword">if</span> (!vd-&gt;lossy) &#123;</span><br><span class="line">        vd-&gt;non_adaptive = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tlsauthz) &#123;</span><br><span class="line">        vd-&gt;tlsauthzid = g_strdup(tlsauthz);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (acl) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(vd-&gt;id, <span class="string">"default"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            vd-&gt;tlsauthzid = g_strdup(<span class="string">"vnc.x509dname"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            vd-&gt;tlsauthzid = g_strdup_printf(<span class="string">"vnc.%s.x509dname"</span>, vd-&gt;id);</span><br><span class="line">        &#125;</span><br><span class="line">        vd-&gt;tlsauthz = QAUTHZ(qauthz_list_new(vd-&gt;tlsauthzid,</span><br><span class="line">                                              QAUTHZ_LIST_POLICY_DENY,</span><br><span class="line">                                              &amp;error_abort));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VNC_SASL</span></span><br><span class="line">    <span class="keyword">if</span> (sasl) &#123;</span><br><span class="line">        <span class="keyword">if</span> (saslauthz) &#123;</span><br><span class="line">            vd-&gt;sasl.authzid = g_strdup(saslauthz);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (acl) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(vd-&gt;id, <span class="string">"default"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                vd-&gt;sasl.authzid = g_strdup(<span class="string">"vnc.username"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                vd-&gt;sasl.authzid = g_strdup_printf(<span class="string">"vnc.%s.username"</span>, vd-&gt;id);</span><br><span class="line">            &#125;</span><br><span class="line">            vd-&gt;sasl.authz = QAUTHZ(qauthz_list_new(vd-&gt;sasl.authzid,</span><br><span class="line">                                                    QAUTHZ_LIST_POLICY_DENY,</span><br><span class="line">                                                    &amp;error_abort));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/*设置vnc认证方式*/</span></span><br><span class="line">    <span class="keyword">if</span> (vnc_display_setup_auth(&amp;vd-&gt;auth, &amp;vd-&gt;subauth,</span><br><span class="line">                               vd-&gt;tlscreds, password,</span><br><span class="line">                               sasl, <span class="literal">false</span>, errp) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    trace_vnc_auth_init(vd, <span class="number">0</span>, vd-&gt;auth, vd-&gt;subauth);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vnc_display_setup_auth(&amp;vd-&gt;ws_auth, &amp;vd-&gt;ws_subauth,</span><br><span class="line">                               vd-&gt;tlscreds, password,</span><br><span class="line">                               sasl, <span class="literal">true</span>, errp) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    trace_vnc_auth_init(vd, <span class="number">1</span>, vd-&gt;ws_auth, vd-&gt;ws_subauth);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VNC_SASL</span></span><br><span class="line">    <span class="keyword">if</span> (sasl) &#123;  <span class="comment">/*sasl认证初始化*/</span></span><br><span class="line">        <span class="keyword">int</span> saslErr = sasl_server_init(<span class="literal">NULL</span>, <span class="string">"qemu"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (saslErr != SASL_OK) &#123;</span><br><span class="line">            error_setg(errp, <span class="string">"Failed to initialize SASL auth: %s"</span>,</span><br><span class="line">                       sasl_errstring(saslErr, <span class="literal">NULL</span>, <span class="literal">NULL</span>));</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/*支持numlock和capslock状态同步*/</span></span><br><span class="line">    vd-&gt;lock_key_sync = lock_key_sync;</span><br><span class="line">    <span class="keyword">if</span> (lock_key_sync) &#123;</span><br><span class="line">        vd-&gt;led = qemu_add_led_event_handler(kbd_leds, vd);</span><br><span class="line">    &#125;</span><br><span class="line">    vd-&gt;ledstate = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/*显示设备信息*/</span></span><br><span class="line">    device_id = qemu_opt_get(opts, <span class="string">"display"</span>);</span><br><span class="line">    <span class="keyword">if</span> (device_id) &#123;</span><br><span class="line">        <span class="keyword">int</span> head = qemu_opt_get_number(opts, <span class="string">"head"</span>, <span class="number">0</span>);</span><br><span class="line">        Error *err = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        con = qemu_console_lookup_by_device_name(device_id, head, &amp;err);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            error_propagate(errp, err);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        con = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*如果不是默认的控制台则重新注册dcl_ops*/</span></span><br><span class="line">    <span class="keyword">if</span> (con != vd-&gt;dcl.con) &#123;</span><br><span class="line">        qkbd_state_free(vd-&gt;kbd);</span><br><span class="line">        unregister_displaychangelistener(&amp;vd-&gt;dcl);</span><br><span class="line">        vd-&gt;dcl.con = con;</span><br><span class="line">        register_displaychangelistener(&amp;vd-&gt;dcl);</span><br><span class="line">        vd-&gt;kbd = qkbd_state_init(vd-&gt;dcl.con);</span><br><span class="line">    &#125;</span><br><span class="line">    qkbd_state_set_delay(vd-&gt;kbd, key_delay_ms);<span class="comment">/*键盘延迟时间*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (saddr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reverse) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vnc_display_connect(vd, saddr, nsaddr, wsaddr, nwsaddr, errp) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">/*开始监听*/</span></span><br><span class="line">        <span class="keyword">if</span> (vnc_display_listen(vd, saddr, nsaddr, wsaddr, nwsaddr, errp) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (qemu_opt_get(opts, <span class="string">"to"</span>)) &#123;</span><br><span class="line">        vnc_display_print_local_addr(vd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> cleanup:</span><br><span class="line">    vnc_free_addresses(&amp;saddr, &amp;nsaddr);</span><br><span class="line">    vnc_free_addresses(&amp;wsaddr, &amp;nwsaddr);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">    vnc_display_close(vd);</span><br><span class="line">    <span class="keyword">goto</span> cleanup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vnc_display_setup_auth函数负责设置vnc客户端连接的认证方式，vnc的认证有方式有：password，sasl,none三种，vnc的Channel可以有clear和tls两种模式，使用tls模式的时候可以使用anon和x509两种类型的证书，所以组合起来有9中方式：</p>
<ul>
<li>clear + none</li>
<li>clear + password</li>
<li>clear + sasl</li>
<li>tls + anon + none</li>
<li>tls + anon + password</li>
<li>tls + anon + sasl</li>
<li>tls + x509 + none</li>
<li>tls + x509 + password</li>
<li>tls + x509 + sasl</li>
</ul>
<p>vnc监听是在vnc_display_listen中完成的，同时注册了连接过来时的处理函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vnc_display_listen</span><span class="params">(VncDisplay *vd,</span></span></span><br><span class="line"><span class="function"><span class="params">                              SocketAddress **saddr,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">size_t</span> nsaddr,</span></span></span><br><span class="line"><span class="function"><span class="params">                              SocketAddress **wsaddr,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">size_t</span> nwsaddr,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> i;</span><br><span class="line">    <span class="comment">/*tcp监听*/</span></span><br><span class="line">    <span class="keyword">if</span> (nsaddr) &#123;</span><br><span class="line">        vd-&gt;listener = qio_net_listener_new();</span><br><span class="line">        qio_net_listener_set_name(vd-&gt;listener, <span class="string">"vnc-listen"</span>);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nsaddr; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (qio_net_listener_open_sync(vd-&gt;listener,</span><br><span class="line">                                           saddr[i],</span><br><span class="line">                                           errp) &lt; <span class="number">0</span>)  &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        qio_net_listener_set_client_func(vd-&gt;listener,</span><br><span class="line">                                         vnc_listen_io, vd, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*websocket监听*/</span></span><br><span class="line">    <span class="keyword">if</span> (nwsaddr) &#123;</span><br><span class="line">        vd-&gt;wslistener = qio_net_listener_new();</span><br><span class="line">        qio_net_listener_set_name(vd-&gt;wslistener, <span class="string">"vnc-ws-listen"</span>);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nwsaddr; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (qio_net_listener_open_sync(vd-&gt;wslistener,</span><br><span class="line">                                           wsaddr[i],</span><br><span class="line">                                           errp) &lt; <span class="number">0</span>)  &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        qio_net_listener_set_client_func(vd-&gt;wslistener,</span><br><span class="line">                                         vnc_listen_io, vd, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中vnc_listen_io是客户端连接时的回调处理函数，到此vnc初始化完成，等待客户端的连接。</p>
<h2 id="VNC客户端连接流程分析"><a href="#VNC客户端连接流程分析" class="headerlink" title="VNC客户端连接流程分析"></a>VNC客户端连接流程分析</h2><p>上面讲到vnc_listen_io是在vnc客户端连接时触发的回调函数，vnc_listen_io的流程如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">vnc_listen_io</span><span class="params">(QIONetListener *listener,</span></span></span><br><span class="line"><span class="function"><span class="params">                          QIOChannelSocket *cioc,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">void</span> *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VncDisplay *vd = opaque;</span><br><span class="line">    <span class="comment">/*判断是否为websocket server*/</span></span><br><span class="line">    <span class="keyword">bool</span> isWebsock = listener == vd-&gt;wslistener;</span><br><span class="line">    <span class="comment">/*设置client channel名称*/</span></span><br><span class="line">    qio_channel_set_name(QIO_CHANNEL(cioc),</span><br><span class="line">                         isWebsock ? <span class="string">"vnc-ws-server"</span> : <span class="string">"vnc-server"</span>);</span><br><span class="line">    <span class="comment">/*设置TCPNODELAY*/</span></span><br><span class="line">    qio_channel_set_delay(QIO_CHANNEL(cioc), <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">/*真正处理vnc client连接的函数*/</span></span><br><span class="line">    vnc_connect(vd, cioc, <span class="literal">false</span>, isWebsock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vnc_connect是真正处理客户端连接的函数:会为当前连接进来的client分配一个VncState，并，之后初始化VncState中的各项参数:各种buffer(包括input/output buffer，job buffer以及各种压缩方式的buffer),设置AUTH方式，为lossy_rect分配内存，调整gui_update的更新间隔为VNC_REFRESH_INTERVAL_BASE等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">vnc_connect</span><span class="params">(VncDisplay *vd, QIOChannelSocket *sioc,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">bool</span> skipauth, <span class="keyword">bool</span> websocket)</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="comment">/*设置VncState对应的VncDisplay*/</span></span><br><span class="line">    VncState *vs = g_new0(VncState, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">bool</span> first_client = QTAILQ_EMPTY(&amp;vd-&gt;clients);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">/*将VncState实例加入到对应的VncDisplay的client链表中*/</span></span><br><span class="line">    trace_vnc_client_connect(vs, sioc);</span><br><span class="line">    vs-&gt;magic = VNC_MAGIC;</span><br><span class="line">    vs-&gt;sioc = sioc;</span><br><span class="line">    object_ref(OBJECT(vs-&gt;sioc));</span><br><span class="line">    vs-&gt;ioc = QIO_CHANNEL(sioc);</span><br><span class="line">    object_ref(OBJECT(vs-&gt;ioc));</span><br><span class="line">    vs-&gt;vd = vd;</span><br><span class="line">    <span class="comment">/*初始化input/output buffer，job buffer以及各种压缩方式的buffer)*/</span></span><br><span class="line">    buffer_init(&amp;vs-&gt;input,          <span class="string">"vnc-input/%p"</span>, sioc);</span><br><span class="line">    buffer_init(&amp;vs-&gt;output,         <span class="string">"vnc-output/%p"</span>, sioc);</span><br><span class="line">    buffer_init(&amp;vs-&gt;jobs_buffer,    <span class="string">"vnc-jobs_buffer/%p"</span>, sioc);</span><br><span class="line"></span><br><span class="line">    buffer_init(&amp;vs-&gt;tight.tight,    <span class="string">"vnc-tight/%p"</span>, sioc);</span><br><span class="line">    buffer_init(&amp;vs-&gt;tight.zlib,     <span class="string">"vnc-tight-zlib/%p"</span>, sioc);</span><br><span class="line">    buffer_init(&amp;vs-&gt;tight.gradient, <span class="string">"vnc-tight-gradient/%p"</span>, sioc);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VNC_JPEG</span></span><br><span class="line">    buffer_init(&amp;vs-&gt;tight.jpeg,     <span class="string">"vnc-tight-jpeg/%p"</span>, sioc);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VNC_PNG</span></span><br><span class="line">    buffer_init(&amp;vs-&gt;tight.png,      <span class="string">"vnc-tight-png/%p"</span>, sioc);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    buffer_init(&amp;vs-&gt;zlib.zlib,      <span class="string">"vnc-zlib/%p"</span>, sioc);</span><br><span class="line">    buffer_init(&amp;vs-&gt;zrle.zrle,      <span class="string">"vnc-zrle/%p"</span>, sioc);</span><br><span class="line">    buffer_init(&amp;vs-&gt;zrle.fb,        <span class="string">"vnc-zrle-fb/%p"</span>, sioc);</span><br><span class="line">    buffer_init(&amp;vs-&gt;zrle.zlib,      <span class="string">"vnc-zrle-zlib/%p"</span>, sioc);</span><br><span class="line">    <span class="comment">/*设置VNC认证方式*/</span></span><br><span class="line">    <span class="keyword">if</span> (skipauth) &#123;</span><br><span class="line">        vs-&gt;auth = VNC_AUTH_NONE;</span><br><span class="line">        vs-&gt;subauth = VNC_AUTH_INVALID;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (websocket) &#123;</span><br><span class="line">            vs-&gt;auth = vd-&gt;ws_auth;</span><br><span class="line">            vs-&gt;subauth = VNC_AUTH_INVALID;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            vs-&gt;auth = vd-&gt;auth;</span><br><span class="line">            vs-&gt;subauth = vd-&gt;subauth;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    VNC_DEBUG(<span class="string">"Client sioc=%p ws=%d auth=%d subauth=%d\n"</span>,</span><br><span class="line">              sioc, websocket, vs-&gt;auth, vs-&gt;subauth);</span><br><span class="line">    <span class="comment">/*为lossy_rect分配内存*/</span></span><br><span class="line">    vs-&gt;lossy_rect = g_malloc0(VNC_STAT_ROWS * <span class="keyword">sizeof</span> (*vs-&gt;lossy_rect));</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; VNC_STAT_ROWS; ++i) &#123;</span><br><span class="line">        vs-&gt;lossy_rect[i] = g_new0(<span class="keyword">uint8_t</span>, VNC_STAT_COLS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*设置gui_update的更新间隔时间*/</span></span><br><span class="line">    VNC_DEBUG(<span class="string">"New client on socket %p\n"</span>, vs-&gt;sioc);</span><br><span class="line">    update_displaychangelistener(&amp;vd-&gt;dcl, VNC_REFRESH_INTERVAL_BASE);</span><br><span class="line">    <span class="comment">/*设置socket为nonblocking*/</span></span><br><span class="line">    qio_channel_set_blocking(vs-&gt;ioc, <span class="literal">false</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (vs-&gt;ioc_tag) &#123;</span><br><span class="line">        g_source_remove(vs-&gt;ioc_tag);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (websocket) &#123;</span><br><span class="line">        <span class="comment">/*设置websocket握手以及数据收发的回调处理函数*/</span></span><br><span class="line">        vs-&gt;websocket = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (vd-&gt;tlscreds) &#123;</span><br><span class="line">            vs-&gt;ioc_tag = qio_channel_add_watch(</span><br><span class="line">                vs-&gt;ioc, G_IO_IN, vncws_tls_handshake_io, vs, <span class="literal">NULL</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            vs-&gt;ioc_tag = qio_channel_add_watch(</span><br><span class="line">                vs-&gt;ioc, G_IO_IN, vncws_handshake_io, vs, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*设置数据收发的回调处理函数*/</span></span><br><span class="line">        vs-&gt;ioc_tag = qio_channel_add_watch(</span><br><span class="line">            vs-&gt;ioc, G_IO_IN, vnc_client_io, vs, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*这里是将client地址缓存起来*/</span></span><br><span class="line">    vnc_client_cache_addr(vs);</span><br><span class="line">    vnc_qmp_event(vs, QAPI_EVENT_VNC_CONNECTED);</span><br><span class="line">    <span class="comment">/*更新VNC的连接数*/</span></span><br><span class="line">    vnc_set_share_mode(vs, VNC_SHARE_MODE_CONNECTING);</span><br><span class="line"></span><br><span class="line">    vs-&gt;last_x = <span class="number">-1</span>;</span><br><span class="line">    vs-&gt;last_y = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/*设置音频的采样率为44100Hz，通道为双声道，16位*/</span></span><br><span class="line">    vs-&gt;as.freq = <span class="number">44100</span>;</span><br><span class="line">    vs-&gt;as.nchannels = <span class="number">2</span>;</span><br><span class="line">    vs-&gt;as.fmt = AUDIO_FORMAT_S16;</span><br><span class="line">    vs-&gt;as.endianness = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    qemu_mutex_init(&amp;vs-&gt;output_mutex);</span><br><span class="line">    <span class="comment">/*注册一个bh，回调处理函数位vnc_jobs_bh，这里用到了qemu的aio*/</span></span><br><span class="line">    vs-&gt;bh = qemu_bh_new(vnc_jobs_bh, vs);</span><br><span class="line">    <span class="comment">/*将VncState实例加入到对应的VncDisplay的client链表中*/</span></span><br><span class="line">    QTAILQ_INSERT_TAIL(&amp;vd-&gt;clients, vs, next);</span><br><span class="line">    <span class="keyword">if</span> (first_client) &#123;</span><br><span class="line">        <span class="comment">/*初始化显存内存缓存空间*/</span></span><br><span class="line">        vnc_update_server_surface(vd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*触发显卡设备刷新，在显示设备的gfx_update中都会调用dpx_gfx_update，即将更新区域通知给vnc*/</span></span><br><span class="line">    graphic_hw_update(vd-&gt;dcl.con);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!vs-&gt;websocket) &#123;</span><br><span class="line">        <span class="comment">/*这里开始vnc的RFB协议交互*/</span></span><br><span class="line">        vnc_start_protocol(vs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*如果连接超出，将disconnect这个client*/</span></span><br><span class="line">    <span class="keyword">if</span> (vd-&gt;num_connecting &gt; vd-&gt;connections_limit) &#123;</span><br><span class="line">        QTAILQ_FOREACH(vs, &amp;vd-&gt;clients, next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vs-&gt;share_mode == VNC_SHARE_MODE_CONNECTING) &#123;</span><br><span class="line">                vnc_disconnect_start(vs);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vnc_connect中调用qio_channel_add_watch注册的回调处理函数vnc_client_io负责对client进行数据读写:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">gboolean <span class="title">vnc_client_io</span><span class="params">(QIOChannel *ioc G_GNUC_UNUSED,</span></span></span><br><span class="line"><span class="function"><span class="params">                       GIOCondition condition, <span class="keyword">void</span> *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VncState *vs = opaque;</span><br><span class="line"></span><br><span class="line">    assert(vs-&gt;magic == VNC_MAGIC);</span><br><span class="line">    <span class="keyword">if</span> (condition &amp; G_IO_IN) &#123;</span><br><span class="line">    <span class="comment">/*将数据读取到VncState中的input buffer,之后调用回调read_handler进行读取数据处理*/</span></span><br><span class="line">        <span class="keyword">if</span> (vnc_client_read(vs) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* vs is free()ed here */</span></span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (condition &amp; G_IO_OUT) &#123;</span><br><span class="line">    <span class="comment">/*将VncState中的output buffer数据通过QIOChannel的write操作发送给client*/</span></span><br><span class="line">        vnc_client_write(vs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vs-&gt;disconnecting) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vs-&gt;ioc_tag != <span class="number">0</span>) &#123;</span><br><span class="line">            g_source_remove(vs-&gt;ioc_tag);</span><br><span class="line">        &#125;</span><br><span class="line">        vs-&gt;ioc_tag = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vnc_update_server_surface用于初始化显存内容缓存空间以及设置更新的像素:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">vnc_update_server_surface</span><span class="params">(VncDisplay *vd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> width, height;</span><br><span class="line"></span><br><span class="line">    qemu_pixman_image_unref(vd-&gt;server);</span><br><span class="line">    vd-&gt;server = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (QTAILQ_EMPTY(&amp;vd-&gt;clients)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    width = vnc_width(vd);</span><br><span class="line">    height = vnc_height(vd);</span><br><span class="line">    <span class="comment">/*pixman是一个像素处理库，这里是初始化显存内容的缓存空间*/</span></span><br><span class="line">    vd-&gt;server = pixman_image_create_bits(VNC_SERVER_FB_FORMAT,</span><br><span class="line">                                          width, height,</span><br><span class="line">                                          <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">/*这里设置dirty map为全部(坐标(0,0),使用整个显示区域的宽和高)，即第一次连接会全像素更新*/</span></span><br><span class="line">    <span class="built_in">memset</span>(vd-&gt;guest.dirty, <span class="number">0x00</span>, <span class="keyword">sizeof</span>(vd-&gt;guest.dirty));</span><br><span class="line">    vnc_set_area_dirty(vd-&gt;guest.dirty, vd, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                       width, height);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="VNC协议消息交互流程"><a href="#VNC协议消息交互流程" class="headerlink" title="VNC协议消息交互流程"></a>VNC协议消息交互流程</h2><p>vnc客户端和服务端的协议交互是从vnc_start_protocol函数开始，vnc_start_protocol中首先发送服务端RFB版本，然后注册数据读取回调处理函数为protocol_version：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vnc_start_protocol</span><span class="params">(VncState *vs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*将RFB版本写进缓存，vnc_write并不直接调用qio_channel的write操作，而是先写进VncState中的output buffer*/</span></span><br><span class="line">    vnc_write(vs, <span class="string">"RFB 003.008\n"</span>, <span class="number">12</span>);</span><br><span class="line">    <span class="comment">/*vnc_flush才是最终调用QIO_channel的write操作的函数*/</span></span><br><span class="line">    vnc_flush(vs);</span><br><span class="line">    <span class="comment">/*这里会将protocol_version赋值给read_handler，在之前的vnc_client_io中我们知道vnc_client_read会调用read_handler回调函数执行读取操作,这里就是调用protocol_version分析客户端发送过来的版本信息*/</span></span><br><span class="line">    vnc_read_when(vs, protocol_version, <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">    vs-&gt;mouse_mode_notifier.notify = check_pointer_type_change;</span><br><span class="line">    qemu_add_mouse_mode_change_notifier(&amp;vs-&gt;mouse_mode_notifier);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>protocol_version这个函数负责接收客户端发过来的版本信息，并调用客户端的Auth处理函数对客户端连接进行认证：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">protocol_version</span><span class="params">(VncState *vs, <span class="keyword">uint8_t</span> *version, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> local[<span class="number">13</span>];</span><br><span class="line">    <span class="comment">/*头12个字节为version*/</span></span><br><span class="line">    <span class="built_in">memcpy</span>(local, version, <span class="number">12</span>);</span><br><span class="line">    local[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sscanf</span>(local, <span class="string">"RFB %03d.%03d\n"</span>, &amp;vs-&gt;major, &amp;vs-&gt;minor) != <span class="number">2</span>) &#123;</span><br><span class="line">        VNC_DEBUG(<span class="string">"Malformed protocol version %s\n"</span>, local);</span><br><span class="line">        vnc_client_error(vs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    VNC_DEBUG(<span class="string">"Client request protocol version %d.%d\n"</span>, vs-&gt;major, vs-&gt;minor);</span><br><span class="line">    <span class="comment">/*客户端主版本必须为3，并且子版本必须为3，4，5，7，8*/</span></span><br><span class="line">    <span class="keyword">if</span> (vs-&gt;major != <span class="number">3</span> ||</span><br><span class="line">        (vs-&gt;minor != <span class="number">3</span> &amp;&amp;</span><br><span class="line">         vs-&gt;minor != <span class="number">4</span> &amp;&amp;</span><br><span class="line">         vs-&gt;minor != <span class="number">5</span> &amp;&amp;</span><br><span class="line">         vs-&gt;minor != <span class="number">7</span> &amp;&amp;</span><br><span class="line">         vs-&gt;minor != <span class="number">8</span>)) &#123;</span><br><span class="line">        VNC_DEBUG(<span class="string">"Unsupported client version\n"</span>);</span><br><span class="line">        vnc_write_u32(vs, VNC_AUTH_INVALID);</span><br><span class="line">        vnc_flush(vs);</span><br><span class="line">        vnc_client_error(vs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Some broken clients report v3.4 or v3.5, which spec requires to be treated</span></span><br><span class="line"><span class="comment">     * as equivalent to v3.3 by servers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (vs-&gt;minor == <span class="number">4</span> || vs-&gt;minor == <span class="number">5</span>)</span><br><span class="line">        vs-&gt;minor = <span class="number">3</span>;</span><br><span class="line">    <span class="comment">/*如果子版本等于3，直接进行认证*/</span></span><br><span class="line">    <span class="keyword">if</span> (vs-&gt;minor == <span class="number">3</span>) &#123;</span><br><span class="line">        trace_vnc_auth_start(vs, vs-&gt;auth);</span><br><span class="line">        <span class="keyword">if</span> (vs-&gt;auth == VNC_AUTH_NONE) &#123;</span><br><span class="line">            vnc_write_u32(vs, vs-&gt;auth);</span><br><span class="line">            vnc_flush(vs);</span><br><span class="line">            trace_vnc_auth_pass(vs, vs-&gt;auth);</span><br><span class="line">            start_client_init(vs);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vs-&gt;auth == VNC_AUTH_VNC) &#123;</span><br><span class="line">            VNC_DEBUG(<span class="string">"Tell client VNC auth\n"</span>);</span><br><span class="line">            vnc_write_u32(vs, vs-&gt;auth);</span><br><span class="line">            vnc_flush(vs);</span><br><span class="line">            start_auth_vnc(vs);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            trace_vnc_auth_fail(vs, vs-&gt;auth,</span><br><span class="line">                                <span class="string">"Unsupported auth method for v3.3"</span>, <span class="string">""</span>);</span><br><span class="line">            vnc_write_u32(vs, VNC_AUTH_INVALID);</span><br><span class="line">            vnc_flush(vs);</span><br><span class="line">            vnc_client_error(vs);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*如果子版本不等于3则调用protocol_client_auth进行认证*/</span></span><br><span class="line">        vnc_write_u8(vs, <span class="number">1</span>); <span class="comment">/* num auth */</span></span><br><span class="line">        vnc_write_u8(vs, vs-&gt;auth);</span><br><span class="line">        vnc_read_when(vs, protocol_client_auth, <span class="number">1</span>);</span><br><span class="line">        vnc_flush(vs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>protocol_client_auth用于处理其他版本的认证，之后会根据认证方式选择认证函数：none直接调用start_client_init，vnc认证调用start_auth_vnc，VENCRYPT认证调用start_auth_vencrypt，sasl认证调用start_auth_sasl，除了none认证外，其他认证方式认证完都会调用start_client_init。这里不对认证做具体分析，直接从start_client_init函数开始，start_client_init会调用protocol_client_init初始化client的参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start_client_init</span><span class="params">(VncState *vs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vnc_read_when(vs, protocol_client_init, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">protocol_client_init</span><span class="params">(VncState *vs, <span class="keyword">uint8_t</span> *data, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    VncShareMode mode;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line">    mode = data[<span class="number">0</span>] ? VNC_SHARE_MODE_SHARED : VNC_SHARE_MODE_EXCLUSIVE;</span><br><span class="line">    <span class="keyword">switch</span> (vs-&gt;vd-&gt;share_policy) &#123;</span><br><span class="line">    <span class="keyword">case</span> VNC_SHARE_POLICY_IGNORE:</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Ignore the shared flag.  Nothing to do here.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Doesn't conform to the rfb spec but is traditional qemu</span></span><br><span class="line"><span class="comment">         * behavior, thus left here as option for compatibility</span></span><br><span class="line"><span class="comment">         * reasons.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VNC_SHARE_POLICY_ALLOW_EXCLUSIVE:</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Policy: Allow clients ask for exclusive access.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Implementation: When a client asks for exclusive access,</span></span><br><span class="line"><span class="comment">         * disconnect all others. Shared connects are allowed as long</span></span><br><span class="line"><span class="comment">         * as no exclusive connection exists.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This is how the rfb spec suggests to handle the shared flag.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mode == VNC_SHARE_MODE_EXCLUSIVE) &#123;</span><br><span class="line">            VncState *client;</span><br><span class="line">            QTAILQ_FOREACH(client, &amp;vs-&gt;vd-&gt;clients, next) &#123;</span><br><span class="line">                <span class="keyword">if</span> (vs == client) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (client-&gt;share_mode != VNC_SHARE_MODE_EXCLUSIVE &amp;&amp;</span><br><span class="line">                    client-&gt;share_mode != VNC_SHARE_MODE_SHARED) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                vnc_disconnect_start(client);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mode == VNC_SHARE_MODE_SHARED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vs-&gt;vd-&gt;num_exclusive &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                vnc_disconnect_start(vs);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VNC_SHARE_POLICY_FORCE_SHARED:</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Policy: Shared connects only.</span></span><br><span class="line"><span class="comment">         * Implementation: Disallow clients asking for exclusive access.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Useful for shared desktop sessions where you don't want</span></span><br><span class="line"><span class="comment">         * someone forgetting to say -shared when running the vnc</span></span><br><span class="line"><span class="comment">         * client disconnect everybody else.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mode == VNC_SHARE_MODE_EXCLUSIVE) &#123;</span><br><span class="line">            vnc_disconnect_start(vs);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*初始化client的共享模式*/</span></span><br><span class="line">    vnc_set_share_mode(vs, mode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*判断连接数是否超限*/</span></span><br><span class="line">    <span class="keyword">if</span> (vs-&gt;vd-&gt;num_shared &gt; vs-&gt;vd-&gt;connections_limit) &#123;</span><br><span class="line">        vnc_disconnect_start(vs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assert(pixman_image_get_width(vs-&gt;vd-&gt;server) &lt; <span class="number">65536</span> &amp;&amp;</span><br><span class="line">           pixman_image_get_width(vs-&gt;vd-&gt;server) &gt;= <span class="number">0</span>);</span><br><span class="line">    assert(pixman_image_get_height(vs-&gt;vd-&gt;server) &lt; <span class="number">65536</span> &amp;&amp;</span><br><span class="line">           pixman_image_get_height(vs-&gt;vd-&gt;server) &gt;= <span class="number">0</span>);</span><br><span class="line">    vs-&gt;client_width = pixman_image_get_width(vs-&gt;vd-&gt;server);</span><br><span class="line">    vs-&gt;client_height = pixman_image_get_height(vs-&gt;vd-&gt;server);</span><br><span class="line">    <span class="comment">/*将显示的宽高发送给client*/</span></span><br><span class="line">    vnc_write_u16(vs, vs-&gt;client_width);</span><br><span class="line">    vnc_write_u16(vs, vs-&gt;client_height);</span><br><span class="line">    <span class="comment">/*初始化每像素的颜色数据的格式，以及设置write_pixels回调处理函数*/</span></span><br><span class="line">    pixel_format_message(vs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (qemu_name) &#123;</span><br><span class="line">        size = <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"QEMU (%s)"</span>, qemu_name);</span><br><span class="line">        <span class="keyword">if</span> (size &gt; <span class="keyword">sizeof</span>(buf)) &#123;</span><br><span class="line">            size = <span class="keyword">sizeof</span>(buf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        size = <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"QEMU"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*发送qemu_name*/</span></span><br><span class="line">    vnc_write_u32(vs, size);</span><br><span class="line">    vnc_write(vs, buf, size);</span><br><span class="line">    vnc_flush(vs);</span><br><span class="line">    <span class="comment">/*记录认证信息*/</span></span><br><span class="line">    vnc_client_cache_auth(vs);</span><br><span class="line">    vnc_qmp_event(vs, QAPI_EVENT_VNC_INITIALIZED);</span><br><span class="line">    <span class="comment">/*开始处理vnc客户端发来的消息*/</span></span><br><span class="line">    vnc_read_when(vs, protocol_client_msg, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="tags"><a href="/tags/qemu/">qemu</a></div><div class="post-nav"><a class="next" href="/2019/08/13/虚拟机性能优化/">虚拟机性能优化</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' ? true : false;
var verify = 'false' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'AlLqxqlQnpOFTfDcaoJiSMPs-MdYXbMMI',
  appKey:'d3iJMQyd4DedYStR50BOzN7z',
  placeholder:'≧∀≦欢迎评论',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://huazq.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/内核/">内核</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/文件系统/">文件系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂类/">杂类</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化/">虚拟化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/libvirt/" style="font-size: 15px;">libvirt</a> <a href="/tags/qemu/" style="font-size: 15px;">qemu</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/01/18/Qemu中VNC-Server分析/">Qemu中VNC Server分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/13/虚拟机性能优化/">虚拟机性能优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/10/虚拟化资源复用/">虚拟机资源Qos分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/08/eventfd分析/">eventfd分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/07/tmpfs介绍/">tmpfs介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/07/Markdown语法/">Markdown语法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">huazq's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>